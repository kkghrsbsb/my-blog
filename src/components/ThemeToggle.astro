---
import { Button } from '@/components/ui/button'
import { Icon } from 'astro-icon/components'
---

<Button
  id="theme-toggle"
  variant="ghost"
  size="icon"
  title="Toggle theme"
  className="-my-2 -me-2 size-8"
>
  <Icon name="lucide:sun" class="size-4 dark:hidden" />
  <Icon name="lucide:moon" class="absolute hidden size-4 dark:block" />
  <span class="sr-only">Toggle theme</span>
</Button>

<script is:inline data-astro-rerun>
  ;(() => {
    const theme = (() => {
      const stored = localStorage?.getItem('theme') ?? ''
      if (['dark', 'light'].includes(stored)) return stored
      return window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light'
    })()

    document.documentElement.setAttribute('data-theme', theme)
    window.localStorage.setItem('theme', theme)
  })()
</script>

<script>
  function applyTheme(newTheme) {
    const element = document.documentElement
    element.setAttribute('data-theme', newTheme)
    localStorage.setItem('theme', newTheme)
  }

  function getToggleOrigin(event) {
    const target = event?.currentTarget
    const rect = target?.getBoundingClientRect?.()
    const fallbackX = rect ? rect.left + rect.width / 2 : window.innerWidth / 2
    const fallbackY = rect ? rect.top + rect.height / 2 : window.innerHeight / 2

    if ('clientX' in event && 'clientY' in event) {
      const hasPointer = event.clientX !== 0 || event.clientY !== 0
      if (hasPointer) {
        return { x: event.clientX, y: event.clientY }
      }
    }

    return { x: fallbackX, y: fallbackY }
  }

  function handleToggleClick(event) {
    const element = document.documentElement
    const currentTheme = element.getAttribute('data-theme')
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark'
    const prefersReducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)',
    ).matches
    const supportsViewTransition =
      typeof document.startViewTransition === 'function'

    if (!supportsViewTransition || prefersReducedMotion) {
      element.classList.add('[&_*]:transition-none')
      applyTheme(newTheme)
      window.getComputedStyle(element).getPropertyValue('opacity')

      requestAnimationFrame(() => {
        element.classList.remove('[&_*]:transition-none')
      })

      return
    }

    const { x, y } = getToggleOrigin(event)
    const maxX = Math.max(x, window.innerWidth - x)
    const maxY = Math.max(y, window.innerHeight - y)
    const radius = Math.hypot(maxX, maxY)

    element.style.setProperty('--theme-toggle-x', `${x}px`)
    element.style.setProperty('--theme-toggle-y', `${y}px`)
    element.style.setProperty('--theme-toggle-radius', `${radius}px`)
    element.setAttribute('data-theme-transition', 'circle')

    const transition = document.startViewTransition(() => {
      applyTheme(newTheme)
    })

    transition.finished.finally(() => {
      element.removeAttribute('data-theme-transition')
    })
  }

  function initThemeToggle() {
    document
      .getElementById('theme-toggle')
      ?.addEventListener('click', handleToggleClick)
  }

  initThemeToggle()

  document.addEventListener('astro:after-swap', () => {
    const storedTheme = localStorage.getItem('theme') || 'light'
    const element = document.documentElement

    element.classList.add('[&_*]:transition-none')
    window.getComputedStyle(element).getPropertyValue('opacity')
    element.setAttribute('data-theme', storedTheme)

    requestAnimationFrame(() => {
      element.classList.remove('[&_*]:transition-none')
    })

    initThemeToggle()
  })
</script>
